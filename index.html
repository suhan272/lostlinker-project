<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LostLinker</title>
  <style>
    /* ... (CSS remains unchanged from your original code) ... */
    body { margin:0; font-family:"Poppins",sans-serif;
      background:linear-gradient(135deg,#fff7e6,#ffe6f2,#e6f7ff);
      background-size:400% 400%; animation:gradientShift 12s ease infinite;
      color:#333; overflow-x:hidden; }
    h1,h2{ text-align:center; margin:10px 0; font-family:"Baloo 2",cursive;
      color:#444; animation:fadeIn 1.5s ease; }
    a{ color:#ff66a3; text-decoration:none; font-weight:bold; cursor:pointer; }
    .floating{ position:fixed; top:-100px; font-size:2rem; opacity:0.8;
      animation:floatDown 12s linear infinite; z-index:0; }
    .floating:nth-child(1){ left:8%; animation-duration:11s; }
    .floating:nth-child(2){ left:20%; animation-duration:13s; }
    .floating:nth-child(3){ left:35%; animation-duration:15s; }
    .floating:nth-child(4){ left:50%; animation-duration:12s; }
    .floating:nth-child(5){ left:65%; animation-duration:16s; }
    .floating:nth-child(6){ left:75%; animation-duration:14s; }
    .floating:nth-child(7){ left:88%; animation-duration:17s; }
    .floating:nth-child(8){ left:25%; animation-duration:19s; }
    .floating:nth-child(9){ left:55%; animation-duration:20s; }
    @keyframes floatDown {
      0%{ transform:translateY(-100px) rotate(0deg); opacity:0.7; }
      50%{ opacity:1; }
      100%{ transform:translateY(110vh) rotate(360deg); opacity:0; }
    }
    button{ background:linear-gradient(135deg,#ff9eb5,#ffcba4); color:#fff;
      border:none; padding:10px 20px; border-radius:12px; cursor:pointer;
      transition:all 0.3s ease; font-size:1rem;
      box-shadow:0 4px 8px rgba(255,160,200,0.4); margin:5px; }
    button:hover{ background:linear-gradient(135deg,#ff7b9c,#ffb380);
      transform:translateY(-3px) scale(1.05);
      box-shadow:0 6px 12px rgba(255,120,180,0.5); }
    input,select,textarea{ width:90%; padding:10px; margin:8px 0; border:2px solid #ffd6e7;
      border-radius:10px; outline:none; transition:0.3s; font-size:1rem; }
    textarea{ min-height:80px; resize:vertical; }
    input:focus,select:focus,textarea:focus{ border-color:#ff80bf; box-shadow:0 0 8px #ffb3d9; }
    .hidden{ display:none; }
    .container{ width:100%; max-width:500px; margin:40px auto; background:#fff;
      padding:25px; border-radius:20px; box-shadow:0 8px 20px rgba(255,180,200,0.3);
      animation:slideUp 1s ease; position:relative; z-index:1; }
    .navbar{ display:flex; align-items:center; justify-content:space-between;
      background:linear-gradient(135deg,#ffb3ba,#bae1ff); padding:12px 20px;
      color:white; font-weight:bold; border-radius:0 0 20px 20px;
      box-shadow:0 3px 12px rgba(0,0,0,0.2); }
    .navbar input{ padding:8px; border-radius:12px; border:none; width:250px;
      box-shadow:0 2px 6px rgba(0,0,0,0.1); }
    .interface{ padding:20px; text-align:center; animation:fadeIn 1.2s ease; }
    .block{ display:inline-block; width:40%; margin:20px; padding:40px 20px;
      background:#fff0f6; border-radius:18px;
      box-shadow:0 4px 10px rgba(255,120,160,0.3); cursor:pointer;
      transition:all 0.4s ease; font-size:1.2rem; }
    .block:hover{ transform:translateY(-5px) rotate(-1deg); background:#ffe6f7;
      box-shadow:0 6px 14px rgba(255,100,180,0.4); }
    .tabs { display:flex; justify-content:center; margin:15px 0; }
    .tab-btn { padding:10px 20px; border:none; cursor:pointer; background:#eee; margin:0 5px; border-radius:8px; font-weight:bold; }
    .tab-btn.active { background:#ff80bf; color:white; }
    .post { background:#f9f9ff; margin:15px 0; padding:15px; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.1); text-align:left; }
    .post img{ width:60px; height:60px; border-radius:8px; vertical-align:middle; margin-right:10px; object-fit:cover }
    .postHeader{ display:flex; align-items:center; gap:12px }
    .smallBtn{ padding:6px 10px; font-size:0.9rem; border-radius:8px; }
    .chatModal{ position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); background:#fff; padding:18px; border-radius:12px; box-shadow:0 8px 30px rgba(0,0,0,0.3); z-index:2000; width:90%; max-width:420px; }
    .overlay{ position:fixed; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.4); z-index:1500; }
    .message-container { max-height: 300px; overflow-y: auto; margin: 15px 0; border: 1px solid #ddd; border-radius: 8px; padding: 10px; }
    .message { margin: 10px 0; padding: 8px; border-radius: 8px; }
    .sent { background-color: #e1f5fe; text-align: right; }
    .received { background-color: #f5f5f5; text-align: left; }
    .inbox-item { background:#f9f9ff; margin:10px 0; padding:10px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1); cursor:pointer; }
    .inbox-item:hover { background:#e3f2fd; }
    .unread-count { background: #ff4081; color: white; border-radius: 50%; padding: 2px 8px; font-size: 0.8rem; }
    @keyframes gradientShift{0%{background-position:0% 50%;}50%{background-position:100% 50%;}100%{background-position:0% 50%;}}
    @keyframes fadeIn{ from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }
    @keyframes slideUp{ from{opacity:0; transform:translateY(30px);} to{opacity:1; transform:translateY(0);} }
  </style>
</head>
<body>

<div id="landingPage" style="
  position:fixed; top:0; left:0; width:100%; height:100%;
  background:linear-gradient(135deg,#fff7e6,#ffe6f2,#e6f7ff);
  display:flex; flex-direction:column; justify-content:center; align-items:center;
  z-index:9999;
">
  <div id="floatingIconsLanding">
    <div class="floating">üîë</div><div class="floating">üéí</div>
    <div class="floating">üìö</div><div class="floating">üìú</div>
    <div class="floating">üñä</div><div class="floating">üì±</div>
    <div class="floating">üß¥</div><div class="floating">üíª</div>
    <div class="floating">üéß</div>
  </div>

  <div style="
    position:absolute; top:0; width:100%; display:flex; justify-content:space-between;
    padding:20px 40px; font-family:'Poppins',sans-serif; font-weight:bold; font-size:1.2rem; color:#333;
  ">
    <div>üîó LostLinker</div>
    <div style="display:flex; gap:20px;">
      <a onclick="showSection('home')">Home</a>
      <a onclick="showSection('about')">About</a>
      <a onclick="showSection('services')">Services</a>
      <a onclick="showSection('how')">How it Works</a>
      <a onclick="showSection('contact')">Contact</a>
    </div>
  </div>

  <div id="landingContent" style="text-align:center; margin-top:50px; z-index:1; width:80%; max-width:700px;">
    <div id="home" class="landing-section">
      <h1 style="font-family:'Baloo 2', cursive; color:#444;">Welcome to LostLinker</h1>
      <p style="color:#666; margin:15px 0;">Find or report lost & found items in your college</p>
      <div style="display:flex; gap:20px; margin-top:30px; justify-content:center;">
        <button onclick="showLogin()">Login</button>
        <button onclick="showSignup()">Sign Up</button>
      </div>
    </div>
    <div id="about" class="landing-section hidden">
      <h1>About LostLinker</h1>
      <p>LostLinker is a campus-based lost & found portal that connects students to recover misplaced items such as ID cards, phones, books, or accessories.</p>
      <p>Our aim is to make your college a safer and more connected place by helping you quickly report and find items.</p>
      <p>‚ö† Strict Warning

Once your lost or found issue is resolved, you must delete your post immediately.
Failure to do so will be treated as misuse of the platform and reported to the HOD for disciplinary¬†action.</p>
    </div>
    <div id="services" class="landing-section hidden">
      <h1>Our Services</h1>
      <ul style="list-style:none; padding:0; color:#555; line-height:1.8;">
        <li>üì¶ Report Lost Items with details</li>
        <li>üîç Report Found Items easily</li>
        <li>üí¨ Chat & connect with finders</li>
        <li>üì∏ Upload item images for quick recognition</li>
        <li>üè´ Campus-specific filtering for clarity</li>
      </ul>
    </div>
    <div id="how" class="landing-section hidden">
      <h1>How It Works</h1>
      <p>‚ø° Sign up using your official college email.</p>
      <p>‚ø¢ Post details of any lost or found item with an image.</p>
      <p>‚ø£ Browse other posts or search by name, type, or location.</p>
      <p>‚ø§ Contact the person who found or lost the item and recover it easily.</p>
    </div>
    <div id="contact" class="landing-section hidden">
      <h1>Contact Us</h1>
      <p>üìû +91 98765 43210</p>
      <p>üìß support@lostlinker.in</p>
      <p>We're here to assist you anytime with your queries or feedback!</p>
    </div>
  </div>
</div>

<div id="signup" class="container hidden">
  <h2>Sign Up</h2>
  <form onsubmit="signup(event)">
    <input type="text" id="signupName" placeholder="Full Name" required>
    <input type="email" id="signupEmail" placeholder="College Email (.edu / .ac.in)" required>
    <input type="password" id="signupPassword" placeholder="Password" required>
    <button type="submit">Sign Up</button>
  </form>
  <p>Already have an account? <a onclick="showLogin()">Login</a></p>
</div>

<div id="login" class="container hidden">
  <h2>Login</h2>
  <form onsubmit="login(event)">
    <input type="email" id="loginEmail" placeholder="College Email (.edu / .ac.in)" required>
    <input type="password" id="loginPassword" placeholder="Password" required>
    <button type="submit">Login</button>
    <p><a onclick="showForgotPassword()">Forgot Password?</a></p>
  </form>
  <p>Don't have an account? <a onclick="showSignup()">Sign Up</a></p>
</div>

<div id="forgotPassword" class="container hidden">
  <h2>Forgot Password</h2>
  <form onsubmit="requestPasswordReset(event)">
    <input type="email" id="forgotEmail" placeholder="College Email (.edu / .ac.in)" required>
    <button type="submit">Send Reset Link</button>
  </form>
  <p><a onclick="showLogin()">Back to Login</a></p>
</div>

<div id="resetPassword" class="container hidden">
  <h2>Reset Password</h2>
  <form onsubmit="resetPassword(event)">
    <input type="password" id="newPassword" placeholder="New Password" required>
    <input type="password" id="confirmPassword" placeholder="Confirm Password" required>
    <button type="submit">Reset Password</button>
  </form>
  <p><a onclick="showLogin()">Back to Login</a></p>
</div>

<div id="interface" class="hidden">
  <div class="navbar">
    <h2 id="collegeTitle">üîó LostLinker</h2>
    <div style="display:flex; gap:10px; align-items:center">
      <input type="text" id="searchBar" placeholder="üîç Search items..." oninput="applySearch()">
      <button class="smallBtn" onclick="openInbox()" id="inboxBtn">üì¨ Inbox <span id="unreadCount" class="unread-count hidden">0</span></button>
      <button class="smallBtn" onclick="openProfile()">üë§ Profile</button>
    </div>
  </div>
  <div class="interface">
    <div class="block" onclick="openLostForm()">üì¶ Lost Item</div>
    <div class="block" onclick="openFoundForm()">üîç Found Item</div>
  </div>
  <div style="text-align:center; margin:20px;">
    <button onclick="logout()">üö™ Logout</button>
  </div>

  <div id="posts" style="margin:20px; padding:20px; background:#fff; border-radius:12px; box-shadow:0 4px 10px rgba(0,0,0,0.2);">
    <h2>üìå Reported Items</h2>
    <div class="tabs">
      <button class="tab-btn active" onclick="filterPosts('Lost',event)">Lost</button>
      <button class="tab-btn" onclick="filterPosts('Found',event)">Found</button>
    </div>
    <div id="postList"></div>
  </div>
</div>

<div id="inbox" class="container hidden">
  <h2>üì¨ Your Inbox</h2>
  <div id="inboxList"></div>
  <button onclick="closeInbox()">‚¨Ö Back</button>
</div>

<div id="profile" class="container hidden">
  <h2>Your Profile</h2>
  <div id="profileInfo"></div>
  <button onclick="closeProfile()">‚¨Ö Back</button>
</div>

<div id="lostForm" class="container hidden">
  <h2>Report Lost Item</h2>
  <form id="lostFormEl" onsubmit="submitLost(event)">
    <input type="text" id="lostName" placeholder="Item Name" required>
    <input type="text" id="lostType" placeholder="Item Type" required>
    <input type="text" id="lostLocation" placeholder="Lost Location" required>
    <input type="date" id="lostDate" required>
    <input type="file" id="lostImage" accept="image/*" required>
    <textarea id="lostDesc" placeholder="Description (add details)" required></textarea>
    <button type="submit">Submit</button>
  </form>
  <button onclick="backToInterface()">‚¨Ö Back</button>
</div>

<div id="foundForm" class="container hidden">
  <h2>Report Found Item</h2>
  <form id="foundFormEl" onsubmit="submitFound(event)">
    <input type="text" id="foundName" placeholder="Item Name" required>
    <input type="text" id="foundType" placeholder="Item Type" required>
    <input type="text" id="foundLocation" placeholder="Found Location" required>
    <input type="date" id="foundDate" required>
    <input type="file" id="foundImage" accept="image/*" required>
    <textarea id="foundDesc" placeholder="Description (add details)" required></textarea>
    <button type="submit">Submit</button>
  </form>
  <button onclick="backToInterface()">‚¨Ö Back</button>
</div>

<div id="chatOverlay" class="overlay hidden" onclick="closeChat()"></div>
<div id="chatModal" class="hidden chatModal">
  <div id="chatHeader" style="border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 10px;">
    <h3 id="chatWith">Chat with <span id="chatUserName"></span></h3>
    <button onclick="closeChat()" style="position: absolute; right: 10px; top: 10px; background: #ff6666;">X</button>
  </div>
  <div id="messageContainer" class="message-container"></div>
  <form id="messageForm" onsubmit="sendMessage(event)">
    <div style="display: flex; gap: 10px;">
      <input type="text" id="messageInput" placeholder="Type your message..." style="flex: 1; margin: 0;" required>
      <button type="submit" class="smallBtn">Send</button>
    </div>
  </form>
</div>

<script>
  // --- GLOBAL STATE ---
  // Use environment variable for API URL, fallback to localhost for development
 // Update this to your actual backend URL after deployment
  const API_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
  ? 'http://localhost:3000/api'
  : 'https://lostlinker-project.onrender.com/api';

  
  let currentFilter = "Lost", searchQuery = "", currentCollege = "";
  let currentUser = null; // {name,email,college, isAdmin, _id}
  let currentChat = { userId: null, postId: null, userName: null };
  let resetTokenData = { userId: null, token: null };
  const getToken = () => localStorage.getItem('authToken');

  // --- UI MANAGEMENT (Unchanged/Fixed) ---
  function showFloating(show){
    const floating = document.getElementById("floatingIconsLanding");
    if(document.getElementById("interface").classList.contains("hidden")){
      floating.style.display = show ? "block" : "none";
    } else {
      floating.style.display = "none";
    }
  }
  function showLogin(){ 
    document.getElementById("landingPage").style.display='none'; 
    document.getElementById("signup").classList.add("hidden"); 
    document.getElementById("login").classList.remove("hidden");
    document.getElementById("forgotPassword").classList.add("hidden");
    document.getElementById("resetPassword").classList.add("hidden");
    showFloating(true); 
  }
  function showSignup(){ 
    document.getElementById("landingPage").style.display='none'; 
    document.getElementById("login").classList.add("hidden"); 
    document.getElementById("signup").classList.remove("hidden");
    document.getElementById("forgotPassword").classList.add("hidden");
    document.getElementById("resetPassword").classList.add("hidden");
    showFloating(true); 
  }
  function showForgotPassword(){
    document.getElementById("login").classList.add("hidden");
    document.getElementById("forgotPassword").classList.remove("hidden");
  }
  function showResetPassword(){
    document.getElementById("forgotPassword").classList.add("hidden");
    document.getElementById("resetPassword").classList.remove("hidden");
  }
  function openLostForm(){ document.getElementById("interface").classList.add("hidden"); document.getElementById("lostForm").classList.remove("hidden"); showFloating(true);}
  function openFoundForm(){ document.getElementById("interface").classList.add("hidden"); document.getElementById("foundForm").classList.remove("hidden"); showFloating(true);}
  function backToInterface(){
    document.getElementById("lostForm").classList.add("hidden");
    document.getElementById("foundForm").classList.add("hidden");
    document.getElementById("interface").classList.remove("hidden");
    filterPosts(currentFilter,null); showFloating(false);
  }
  function showSection(sectionId){
    document.getElementById("landingPage").style.display='flex';
    document.getElementById("login").classList.add("hidden"); 
    document.getElementById("signup").classList.add("hidden");
    document.getElementById("forgotPassword").classList.add("hidden");
    document.getElementById("resetPassword").classList.add("hidden");
    document.querySelectorAll('.landing-section').forEach(s=>s.classList.add('hidden'));
    document.getElementById(sectionId).classList.remove('hidden');
    showFloating(true);
  }
  function openProfile(){
    document.getElementById('interface').classList.add('hidden');
    const info = document.getElementById('profileInfo');
    info.innerHTML = `<p><b>Name:</b> ${currentUser.name}</p><p><b>Email:</b> ${currentUser.email}</p><p><b>College:</b> ${currentUser.college}</p><p><b>Role:</b> ${currentUser.isAdmin ? 'Admin' : 'User'}</p>`;
    document.getElementById('profile').classList.remove('hidden');
  }
  function closeProfile(){ document.getElementById('profile').classList.add('hidden'); document.getElementById('interface').classList.remove('hidden'); }
  function openInbox(){
    document.getElementById('interface').classList.add('hidden');
    document.getElementById('inbox').classList.remove('hidden');
    loadInbox();
  }
  function closeInbox(){
    document.getElementById('inbox').classList.add('hidden');
    document.getElementById('interface').classList.remove('hidden');
  }
  function openChat(userId, userName, postId){
    currentChat = { userId, userName, postId };
    document.getElementById('chatUserName').textContent = userName;
    document.getElementById('chatOverlay').classList.remove('hidden');
    document.getElementById('chatModal').classList.remove('hidden');
    loadMessages();
  }
  function closeChat(){
    document.getElementById('chatOverlay').classList.add('hidden');
    document.getElementById('chatModal').classList.add('hidden');
    currentChat = { userId: null, postId: null, userName: null };
  }
  function chatIdFor(a,b){ // Placeholder - chat logic needs a backend
    const arr = [a,b].sort(); return 'chat_'+arr.join('');
  }

  // --- AUTHENTICATION & CORE LOGIC (MODIFIED FOR API) ---

  async function signup(e){
    e.preventDefault();
    const name=document.getElementById("signupName").value.trim();
    const email=document.getElementById("signupEmail").value.trim();
    const password=document.getElementById("signupPassword").value;
    const domain=email.split("@")[1]||"";
    if(!(domain.endsWith(".ac.in")||domain.endsWith(".edu"))){ alert("‚ùå Only official college emails allowed!"); return;}

    try {
      const response = await fetch(`${API_URL}/signup`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, email, password })
      });
      const data = await response.json();

      if (response.ok) {
        alert("‚úÖ Signup successful for " + data.collegeDomain);
        showLogin();
      } else {
        alert("‚ö† Error: " + (data.message || "Something went wrong during signup."));
      }
    } catch (error) {
      alert("‚ö†Ô∏è Network Error. Check if your backend server is running.");
      console.error(error);
    }
  }

  async function login(e){
    e.preventDefault();
    const email=document.getElementById("loginEmail").value.trim();
    const password=document.getElementById("loginPassword").value;

    try {
      const response = await fetch(`${API_URL}/login`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password })
      });
      const data = await response.json();

      if (response.ok) {
        // Store the authentication token and user data
        localStorage.setItem('authToken', data.token);
        currentUser = data.user;
        currentCollege = currentUser.college;

        // Update UI
        const role = currentUser.isAdmin ? 'ADMIN' : currentUser.name;
        document.getElementById("collegeTitle").innerText = `üîó ${currentCollege} - LostLinker (${role})`;

        document.getElementById("login").classList.add("hidden");
        document.getElementById("interface").classList.remove("hidden");
        filterPosts("Lost", null); 
        showFloating(false);
        
        // Load unread message count
        loadUnreadCount();
      } else {
        alert("‚ö† Invalid credentials: " + (data.message || "Login failed."));
      }
    } catch (error) {
      alert("‚ö†Ô∏è Network Error. Check if your backend server is running.");
      console.error(error);
    }
  }
  
  async function requestPasswordReset(e){
    e.preventDefault();
    const email = document.getElementById("forgotEmail").value.trim();
    
    try {
      const response = await fetch(`${API_URL}/forgot-password`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email })
      });
      const data = await response.json();

      if (response.ok) {
        // In a real app, this would be sent via email
        alert("Password reset token: " + data.resetToken + "\\n(User ID: " + data.userId + ")\\n\\nIn a real application, this would be sent to your email.");
        resetTokenData = { userId: data.userId, token: data.resetToken };
        showResetPassword();
      } else {
        alert("‚ö† Error: " + (data.message || "Failed to request password reset."));
      }
    } catch (error) {
      alert("‚ö†Ô∏è Network Error. Check if your backend server is running.");
      console.error(error);
    }
  }
  
  async function resetPassword(e){
    e.preventDefault();
    const newPassword = document.getElementById("newPassword").value;
    const confirmPassword = document.getElementById("confirmPassword").value;
    
    if (newPassword !== confirmPassword) {
      alert("Passwords do not match!");
      return;
    }
    
    try {
      const response = await fetch(`${API_URL}/reset-password`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          userId: resetTokenData.userId, 
          token: resetTokenData.token, 
          newPassword 
        })
      });
      const data = await response.json();

      if (response.ok) {
        alert("‚úÖ Password has been reset successfully!");
        showLogin();
      } else {
        alert("‚ö† Error: " + (data.message || "Failed to reset password."));
      }
    } catch (error) {
      alert("‚ö†Ô∏è Network Error. Check if your backend server is running.");
      console.error(error);
    }
  }
  
  function logout(){
    localStorage.removeItem('authToken');
    currentUser = null;
    currentCollege = '';
    document.getElementById("interface").classList.add("hidden");
    document.getElementById("login").classList.remove("hidden");
    showFloating(true);
  }

  // Helper for image conversion and upload (must be replaced with dedicated API for real use)
  function readFileAsDataURL(file){
    return new Promise((res,rej)=>{
      const fr=new FileReader();
      fr.onload = ()=>res(fr.result);
      fr.onerror = ()=>rej(fr.error);
      fr.readAsDataURL(file);
    });
  }

  async function submitPost(e, type) {
    e.preventDefault();
    const prefix = type.toLowerCase();
    const name = document.getElementById(`${prefix}Name`).value.trim();
    const category = document.getElementById(`${prefix}Type`).value.trim();
    const location = document.getElementById(`${prefix}Location`).value.trim();
    const date = document.getElementById(`${prefix}Date`).value;
    const imgFile = document.getElementById(`${prefix}Image`).files[0];
    const description = document.getElementById(`${prefix}Desc`).value.trim();

    if (!imgFile) { alert('üì∑ Image is required'); return; }
    
    // NOTE: In a production app, the image is uploaded separately, and the server returns a URL.
    // Here, we use Base64 temporarily to keep the payload simpler for this blueprint.
    const imageBase64 = await readFileAsDataURL(imgFile);

    // Fix the field names to match what the backend expects
    const newPost = { 
      type, 
      name,  // This should be 'name' not 'userName'
      category, 
      location, 
      date, 
      description, 
      image: imageBase64 
    };

    console.log('Sending post data:', newPost); // Log the data being sent

    try {
        const response = await fetch(`${API_URL}/posts`, {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${getToken()}` 
            },
            body: JSON.stringify(newPost)
        });
        
        console.log('Response status:', response.status); // Log response status
        
        // Check if the response is HTML instead of JSON
        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('text/html')) {
            const text = await response.text();
            console.error('Received HTML instead of JSON:', text.substring(0, 200));
            alert("‚ö†Ô∏è Network Error: Server returned HTML instead of JSON. Check if the API endpoint is correct.");
            return;
        }
        
        const data = await response.json();
        console.log('Response data:', data); // Log response data

        if (response.ok) {
            alert(`‚úÖ ${type} item submitted!`);
            document.getElementById(`${prefix}FormEl`).reset();
            backToInterface();
        } else {
            alert("‚ö† Error submitting post: " + (data.message || "Failed to submit.") + 
                  (data.received ? "\\nReceived data: " + JSON.stringify(data.received) : ""));
        }
    } catch (error) {
        console.error("Network error:", error);
        // Check if it's a CORS error or network error
        if (error instanceof TypeError && error.message.includes('fetch')) {
            alert("‚ö†Ô∏è Network Error: Cannot connect to the backend server.\\n\\nPlease check:\\n1. If the backend server is running on http://localhost:3000\\n2. If there are any firewall issues\\n3. If you're using the correct URL");
        } else {
            alert("‚ö†Ô∏è Network Error: " + error.message);
        }
    }
  }

  async function submitLost(e) { await submitPost(e, 'Lost'); }
  async function submitFound(e) { await submitPost(e, 'Found'); }
  
  async function filterPosts(type,e){
    currentFilter=type;
    if(e && e.target) e.target.classList.add("active");
    document.querySelectorAll(".tab-btn").forEach(btn=>btn.classList.remove("active"));
    if(type==="Lost") document.querySelectorAll(".tab-btn")[0].classList.add("active");
    else document.querySelectorAll(".tab-btn")[1].classList.add("active");
    
    await displayPosts();
  }

  function applySearch(){
    searchQuery=document.getElementById("searchBar").value.toLowerCase();
    // Re-call displayPosts to filter the current list.
    displayPosts(); 
  }

  async function displayPosts(){
    const list=document.getElementById("postList");
    list.innerHTML="<p>Loading items...</p>";

    try {
        const url = `${API_URL}/posts?type=${currentFilter}&college=${currentUser.college}&search=${searchQuery}`;
        const response = await fetch(url, {
            headers: { 'Authorization': `Bearer ${getToken()}` }
        });
        
        // Check if the response is HTML instead of JSON
        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('text/html')) {
            const text = await response.text();
            console.error('Received HTML instead of JSON:', text.substring(0, 200));
            list.innerHTML = "<p style='color:red;'>‚ö†Ô∏è Server returned HTML instead of JSON. Check if the API endpoint is correct.</p>";
            return;
        }
        
        const posts = await response.json();

        list.innerHTML = ""; // Clear loading message

        if (posts.length === 0) { 
            list.innerHTML = "<p>No " + currentFilter + " items yet.</p>"; 
            return; 
        }

        posts.forEach((p) => {
            const div=document.createElement("div");
            div.className="post";
            // The image field in a full-stack app should hold a URL, but using Base64 for simplicity here.
            const imgTag = `<img src="${p.image}" alt="img">`;
            const canDelete = currentUser.isAdmin || (currentUser && p.userEmail === currentUser.email);

            div.innerHTML = `<div class='postHeader'>${imgTag}<div><b>${p.name}</b> <div style='font-size:0.85rem;color:#666'><b>Category:</b> ${p.category} ‚Ä¢ <b>Location:</b> ${p.location}</div></div></div><div style='margin-top:8px'><b>Date:</b> ${new Date(p.date).toDateString()} <br><b>Posted by:</b> ${p.userName} (${p.userEmail})</div><div style='margin-top:8px'><b>Description:</b> ${p.description}</div>`;

            const actions = document.createElement('div');
            actions.style.marginTop = '10px';

            if(canDelete){
              const delBtn = document.createElement('button'); delBtn.className='smallBtn'; delBtn.textContent='üóë Delete'; delBtn.style.background='#ff6666';
              delBtn.onclick = ()=>{ if(confirm('Delete this post?')){ deletePostById(p._id); } };
              actions.appendChild(delBtn);
            }

            if(currentUser && (currentUser.email !== p.userEmail)){
              const chatBtn = document.createElement('button'); chatBtn.className='smallBtn'; chatBtn.textContent='üí¨ Chat';
              chatBtn.onclick = ()=>{ openChat(p.userId, p.userName, p._id); };
              actions.appendChild(chatBtn);
            }

            div.appendChild(actions);
            list.appendChild(div);
        });

    } catch (error) {
        console.error("Fetch posts error:", error);
        // Check if it's a CORS error or network error
        if (error instanceof TypeError && error.message.includes('fetch')) {
            list.innerHTML = "<p style='color:red;'>‚ö†Ô∏è Cannot connect to the backend server. Please check if the server is running on http://localhost:3000</p>";
        } else {
            list.innerHTML = "<p style='color:red;'>‚ö†Ô∏è Failed to fetch posts. Error: " + error.message + "</p>";
        }
    }
  }

  async function deletePostById(id){
    try {
        const response = await fetch(`${API_URL}/posts/${id}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${getToken()}` }
        });

        if (response.ok) {
            alert('Post deleted successfully.');
            await displayPosts(); 
        } else {
            const data = await response.json();
            alert("‚ö† Error deleting post: " + (data.message || "Failed to delete."));
        }
    } catch (error) {
        console.error("Delete post error:", error);
        // Check if it's a CORS error or network error
        if (error instanceof TypeError && error.message.includes('fetch')) {
            alert("‚ö†Ô∏è Network Error: Cannot connect to the backend server. Please check if the server is running.");
        } else {
            alert("‚ö†Ô∏è Network Error: " + error.message);
        }
    }
  }
  
  // Chat functionality
  async function loadMessages(){
    if (!currentChat.userId || !currentChat.postId) return;
    
    try {
      const response = await fetch(`${API_URL}/messages/${currentChat.userId}/${currentChat.postId}`, {
        headers: { 'Authorization': `Bearer ${getToken()}` }
      });
      const messages = await response.json();
      
      const container = document.getElementById('messageContainer');
      container.innerHTML = '';
      
      messages.forEach(msg => {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${msg.senderId._id === currentUser._id ? 'sent' : 'received'}`;
        messageDiv.innerHTML = `
          <div><strong>${msg.senderId._id === currentUser._id ? 'You' : msg.senderId.name}</strong></div>
          <div>${msg.content}</div>
          <div style="font-size: 0.7rem; color: #666; text-align: right;">${new Date(msg.createdAt).toLocaleTimeString()}</div>
        `;
        container.appendChild(messageDiv);
      });
      
      // Scroll to bottom
      container.scrollTop = container.scrollHeight;
    } catch (error) {
      console.error('Error loading messages:', error);
      // Check if it's a CORS error or network error
      if (error instanceof TypeError && error.message.includes('fetch')) {
        alert("‚ö†Ô∏è Network Error: Cannot connect to the backend server. Please check if the server is running.");
      } else {
        alert("‚ö†Ô∏è Network Error: " + error.message);
      }
    }
  }
  
  async function sendMessage(e){
    e.preventDefault();
    const content = document.getElementById('messageInput').value.trim();
    if (!content) return;
    
    try {
      const response = await fetch(`${API_URL}/messages`, {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${getToken()}` 
        },
        body: JSON.stringify({ 
          receiverId: currentChat.userId,
          postId: currentChat.postId,
          content 
        })
      });
      
      const data = await response.json();
      
      if (response.ok) {
        document.getElementById('messageInput').value = '';
        await loadMessages();
        await loadUnreadCount(); // Update unread count
      } else {
        alert("‚ö† Error sending message: " + (data.message || "Failed to send."));
      }
    } catch (error) {
      console.error("Send message error:", error);
      // Check if it's a CORS error or network error
      if (error instanceof TypeError && error.message.includes('fetch')) {
        alert("‚ö†Ô∏è Network Error: Cannot connect to the backend server. Please check if the server is running.");
      } else {
        alert("‚ö†Ô∏è Network Error: " + error.message);
      }
    }
  }
  
  // Inbox functionality
  async function loadUnreadCount(){
    try {
      const response = await fetch(`${API_URL}/messages/unread-count`, {
        headers: { 'Authorization': `Bearer ${getToken()}` }
      });
      const data = await response.json();
      
      const unreadCountEl = document.getElementById('unreadCount');
      if (data.unreadCount > 0) {
        unreadCountEl.textContent = data.unreadCount;
        unreadCountEl.classList.remove('hidden');
      } else {
        unreadCountEl.classList.add('hidden');
      }
    } catch (error) {
      console.error('Error loading unread count:', error);
      // We don't show an alert here because this is called periodically
    }
  }
  
  async function loadInbox(){
    try {
      const response = await fetch(`${API_URL}/messages/unread`, {
        headers: { 'Authorization': `Bearer ${getToken()}` }
      });
      const messages = await response.json();
      
      const list = document.getElementById('inboxList');
      list.innerHTML = '';
      
      if (messages.length === 0) {
        list.innerHTML = '<p>No unread messages.</p>';
        return;
      }
      
      // Group messages by sender and post
      const groupedMessages = {};
      messages.forEach(msg => {
        const key = `${msg.senderId._id}-${msg.postId._id}`;
        if (!groupedMessages[key]) {
          groupedMessages[key] = {
            sender: msg.senderId,
            post: msg.postId,
            messages: []
          };
        }
        groupedMessages[key].messages.push(msg);
      });
      
      // Display grouped messages
      Object.values(groupedMessages).forEach(group => {
        const div = document.createElement('div');
        div.className = 'inbox-item';
        div.innerHTML = `
          <div><strong>${group.sender.name}</strong> - ${group.post.type} item: ${group.post.name}</div>
          <div style="font-size: 0.9rem; color: #666;">${group.messages.length} unread message(s)</div>
        `;
        div.onclick = () => openChat(group.sender._id, group.sender.name, group.post._id);
        list.appendChild(div);
      });
    } catch (error) {
      console.error('Error loading inbox:', error);
      // Check if it's a CORS error or network error
      if (error instanceof TypeError && error.message.includes('fetch')) {
        alert("‚ö†Ô∏è Network Error: Cannot connect to the backend server. Please check if the server is running.");
      } else {
        alert("‚ö†Ô∏è Network Error: " + error.message);
      }
    }
  }
  
  // Periodically check for new messages
  setInterval(() => {
    if (currentUser && !document.getElementById('interface').classList.contains('hidden')) {
      loadUnreadCount();
    }
  }, 30000); // Check every 30 seconds
</script>
</body>
</html>



